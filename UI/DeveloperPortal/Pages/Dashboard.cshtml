@page
@model DeveloperPortal.Pages.DashboardModel


<div class="page-content">
	<div class="row">
		<div class="col-md-8">
			<h3 class="title" style="color:#393939; margin-bottom: 0;">My Dashboard</h3>
		</div>
	</div>

	<div class="row dashboard-header-row">
		<div class="col-md-10 offset-md-1 button-container">
			<button class="edit-project-button" onclick="DisplayModal()">Edit Project(s)</button>
		</div>
	</div>

	<div class="row" >
		<div class="col-md-10 offset-md-1">
			<div class="dashboard-summary-container content-box">
				<span class="dashboard-summary-header">
					My Projects
				</span>
				<div style="height:88.5%;overflow:auto;scroll-behavior:smooth;scrollbar-width:thin">
					<table id="tblMyProjects" class="display" style="width:100%">
						<thead>
							<tr>
								<th>ACHP Number</th>
								<th>Project Name</th>
								<th>Project Address</th>
								<th>Project Type</th>
								<th>Status</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
	</div>
	<div class="row" style="display:none">
		<div class="col-md-4">
			<div class="dashboard-summary-container content-box">
				<span class="dashboard-summary-header text-bold">
					New Projects Submitted
				</span>
				<div style="height:88.5%;overflow:auto;scroll-behavior:smooth;scrollbar-width:thin">
					<table id="tblNewProjects" class="display" style="width:100%">
						<thead style="display:none">
							<tr>
								<th>Name</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="dashboard-summary-container content-box">
				<span class="dashboard-summary-header text-bold">
					Plan Review
				</span>
				<div style="height:88.5%;overflow:auto;scroll-behavior:smooth;scrollbar-width:thin">
					<table id="tblPlanReview" class="display" style="width:100%">
						<thead style="display:none">
							<tr>
								<th>Name</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="dashboard-summary-container content-box">
				<span class="dashboard-summary-header text-bold">
					Site Inspection
				</span>
				<div style="height:88.5%;overflow:auto;scroll-behavior:smooth;scrollbar-width:thin">
					<table id="tblSiteInspection" class="display" style="width:100%">
						<thead style="display:none">
							<tr>
								<th>Name</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="dashboard-summary-container content-box">
				<span class="dashboard-summary-header text-bold">
					NAC
				</span>
				<div style="height:88.5%;overflow:auto;scroll-behavior:smooth;scrollbar-width:thin">
					<table id="tblNACInspection" class="display" style="width:100%">
						<thead style="display:none">
							<tr>
								<th>Name</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="dashboard-summary-container content-box">
				<span class="dashboard-summary-header text-bold">
					Completed Certification
				</span>
				<div style="height:88.5%;overflow:auto;scroll-behavior:smooth;scrollbar-width:thin">
					<table id="tblCompletedCert" class="display" style="width:100%">
						<thead style="display:none">
							<tr>
								<th>Name</th>
							</tr>
						</thead>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<!--modal-->
<div class="modal fade" id="ActionModal" tabindex="-1" role="dialog"
	 aria-labelledby="ActionModalLabel" aria-hidden="true"
	 data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<!-- Centered modal -->
		<div class="modal-content">

			

			<!-- Modal Header -->
			<div class="modal-header  text-white" style=" background-color : #2C3E5C !important">
				<h5 class="modal-title" id="ActionModalLabel">Edit Project(s)</h5>
				<!-- Disabled X close -->
				<!-- <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button> -->
			</div>

			<!-- Modal Body -->
			<div class="modal-body">
				<p class="small text-danger mb-3">All fields marked with an asterisk (*) are required!</p>
				<h5>Provide your AcHP Number(s)</h5>
				<p class="small mb-3">If you do not know your AcHP Number, please contact your assigned RCS.</p>

				<form id="projectForm" onsubmit="handleSubmit(event)">
					<div class="form-group">
						<label for="acHpInput" class="font-weight-bold required">AcHP Number *</label>
						<div class="input-group">
							<input type="text" id="acHpInput" class="form-control" placeholder="AcHP Number" required>
							<div class="input-group-append">
								<button class="btn btn-primary" type="button" onclick="addProject()">Add</button>
							</div>
						</div>
						<div id="acHpError" class="text-danger mt-1" style="display: none;">Please enter an AcHP Number.</div>
						<div id="noData" class="text-danger mt-1" style="display: none;">No data found.</div>
						<div id="validationMessage" class="text-danger mt-1" style="display: none;"></div>
					</div>

					<!-- Project List -->
					<div id="divProjects" class="mb-3"></div>
				</form>
			</div>

			<!-- Modal Footer -->
			<div class="modal-footer d-flex justify-content-end">
				<button type="submit" class="btn btn-primary" form="projectForm">Submit</button>
				<button type="button" class="btn btn-secondary" onclick="$('#ActionModal').modal('hide')">Cancel</button>
			</div>

		</div>
	</div>
</div>


@section Scripts {
	<script>

				function handleSubmit(e) {
			e.preventDefault(); // prevent form from reloading page

			// Clear previous message
			$('#validationMessage').hide().text('');

			var projects = [];

			// Collect all hidden projectIds
			$('#divProjects input[name="projectIds[]"]').each(function () {
				projects.push($(this).val());
			});

			if (projects.length === 0) {
				$('#validationMessage').text("Please add at least one project before submitting.").show();
				return;
			}

			console.log("Submitting projects:", projects);
			debugger;
			// Send to backend
			$.post("/Dashboard?handler=SubmitProjects", { projects: projects }, function (response) {
				if (response.success) {
					$('#ActionModal').modal('hide');
					PopulateMyProjectData();
				} else {
					$('#validationMessage').text(response.message || "Submission failed.").show();
				}
			});
		}


					$(document).ready(function () {
			PopulateMyProjectData();
		  document.getElementById('cm_loader').style.display = 'none'
		});

			function PopulateMyProjectData() {

						if ($.fn.DataTable.isDataTable('#tblMyProjects')) {
				$('#tblMyProjects').DataTable().clear().destroy();
			}
				$('#tblMyProjects').DataTable({
					ajax: {
						url: APPURL+'Dashboard/GetMyProjectData',
						data: { },
						type: 'POST',
						"headers": {
							"Content-Type": "application/x-www-form-urlencoded"
						},
						dataType: 'json',
						dataSrc: ''
					},
					sorting: true,
					searching: true,
					paging: true,
					info: true,
					header: true,
					columns: [
						{
							data: 'acHPFileProjectNumber',
							render: function (data, type, row, meta) {
								// render event defines the markup of the cell text
								if (row.caseId) {
									if (row.caseId.match(/href="([^"]*)/)) {
										var a = '<a class="dashboard-anchor-plan-review" href="#">' + row.acHPFileProjectNumber + '</a>';
										var href = row.caseId.match(/href="([^"]*)/)[1];
										var queryString = href.split("?");
										var url = "../projectdetail?" + queryString[1];
										a = '<a class="dashboard-anchor-plan-review" href="' + url + '">' + row.acHPFileProjectNumber + '</a>';
										return a;
									}
									else {
										return row.caseId.replace('View Project', row.acHPFileProjectNumber);
									}
								}
								return "";
							}
						},
						{ data: 'projectName' },
						{ data: 'projectAddress', },
						{ data: 'type' },
						{ data: 'status' }
					]
				});
			}

			function PopulateData(tableName, dashboardCategory) {
				$('#' + tableName).DataTable({
					ajax: {
						url: '/Dashboard/GetProjectData',
						data: { name: dashboardCategory },
						type: 'POST',
						"headers": {
							"Content-Type": "application/x-www-form-urlencoded"
						},
						dataType: 'json',
						dataSrc: ''
					},
					sorting: false,
					searching: false,
					paging: false,
					info: false,
					header: false,
					columns: [
						{
							data: 'projectName',
							render: function (data, type, row, meta) { // render event defines the markup of the cell text
								var a = '<a class="dashboard-anchor-plan-review" href="#">' + row.projectName + '</a>';
								if (dashboardCategory == 'PlanReview') {
									var href = row.caseId.match(/href="([^"]*)/)[1];
									var queryString = href.split("?");
									var url = "../planReview/index?" + queryString[1];
									a = '<a class="dashboard-anchor-plan-review" href="' + url + '">' + row.projectName + '</a>';

								}
								return a;

							}
						}
					]
				});
			}

			function DisplayModal(){
				$('#ActionModal').modal('show');
				document.getElementById('acHpError').style.display = 'none';
				document.getElementById('noData').style.display = 'none';
				document.getElementById("acHpInput").value = '';
				document.getElementById('divProjects').innerHTML = '';
			}


			function addProject()
			{
				const input = document.getElementById("acHpInput");
				const value = input.value.trim();
					document.getElementById("noData").style.display = "none";
				if (value === '') {
				document.getElementById("acHpError").style.display = "block";
				return;
				}
				else {
					document.getElementById("acHpError").style.display = "none";
					setTimeout(AddClick, 300);
				}
			}

			function AddClick() {

				var ctlIndex = GetControlIndex();
				console.log('ProjCount: ' + ctlIndex);
				const input = document.getElementById("acHpInput");
				const achpNumber = input.value.trim();

				GetACHPDetail(achpNumber, function (streetName,retAchp,projectId, found)
				{
					debugger;
					retAchp= retAchp;
					var achpNumbers = new Set();
					
					var isDuplicate =false;
						$('#divProjects input[name="projectIds[]"]').each(function () {
						if ($(this).val() === projectId) {
							$('#divAdd').next('.text-danger-custom').remove();
							$('#validationMessage').text("ACHP number alrady Added : " + retAchp).show();
							isDuplicate = true;
							return false; // break loop
						}
					});


					if(isDuplicate)
					{
						return;
					}
					else
					{
						$('#validationMessage').text("Duplicate Project Found: " + retAchp).hide();
					}


					if (!found) 
					{
						$('#divAdd').next('.text-danger-custom').remove();
						document.getElementById("noData").style.display = "block";
						//$('#divAdd').after("<span class='text-danger-custom' style='float:left' id='ctlAdd'>No data found</span>");
							$('#btnAdd').prop('disabled', false);
						return;
					}
					else
					{
						document.getElementById("noData").style.display = "none";
					}

				streetName = streetName.replace(/LOS ANGELES.*/g, ""); // Clean address
				var ctlIndex = GetControlIndex();
				var divToAdd = '<div class="row justify-content-md-center" id="div' + ctlIndex + '">';
				var divACHPWithAddr = '<div class="col-md-4 border-no-right row-padding">' + retAchp + " - " + streetName + '</div>';
				var hiddenProjectId = '<input type="hidden" name="projectIds[]" value="' + projectId + '"/>';
				var divDel = '<div class="col-md-2 text-right border-no-left row-padding">' +
								'<button class="btn btn-outline-secondary btn-sm" type="button" style="border-radius:5px;" id="btnDel' + ctlIndex + '">Delete</button></div>';

				$('#divProjects').append(divToAdd + divACHPWithAddr + divDel + hiddenProjectId + "</div>");
					$('#btnAdd').prop('disabled', false);
			});
		}


			function GetACHPDetail(achpNumber, callback) {

				var token = $('input[name="__RequestVerificationToken"]').val();

				$.ajax({
						url: '/Dashboard?handler=GetACHPDetails',
					type: 'POST',
					contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
					headers: {
						'RequestVerificationToken': token
					},
					data: { achpNumber: achpNumber },
					success: function (data) {
						var retJson = data;

						var respCode = data.responseCode;
						var retAchp = data.achpNumber;
						var streetName = data.streetName;
						var projectId = data.projectId
						var response = data.response;

						if (response && response !== '[]') {
							callback(streetName,retAchp,projectId, true);
						} else {
							callback(null, null,null, false);
						}
					},
					error: function (xhr) {
						console.error("Error:", xhr.status, xhr.responseText);
						callback(null, null, false);
					}
				});
			}


			$(document).on('click', 'button[id^="btnDel"]', function () {
				$(this).closest('div.row').remove();
			});


	</script>
}