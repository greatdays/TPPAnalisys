@model DeveloperPortal.Pages.Account.SummaryModel
@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration

<div class="form-partial-container" style="color: black;">
    <div class="app-form-heading">
        <h2 class="signup-step-header" style="margin-bottom: 2em;">Summary</h2>
    </div>
    <fieldset style="margin-bottom: 2em;">
        <div class="row align-items-center">
            <div class="col-md-6">
                <legend class="app-form-heading">Your Information</legend>
            </div>
            <div class="col-md-6 float-right">
                <button id="btnEditYourInfo" class="btn-primary-outline float-right edit-button">Edit</button>
            </div>
        </div>
        <div class="row align-items-baseline">
            <div class="col-md-12">
                @Html.Label("", "Name", new { @class = "app-input-descr control-label required-label font-weight-bold" })
            </div>
            <div class="col-md-12">
                <span id="spnName"></span>
            </div>
        </div>
        
        <div class="row align-items-baseline">
            <div class="col-md-12">
                @Html.Label("", "Company Name", new { @class = "app-input-descr control-label required-label font-weight-bold" })
            </div>
            <div class="col-md-12">
                <span id="spnCompanyName"></span>
            </div>
        </div>
        <div class="row align-items-baseline">
            <div class="col-md-12">
                @Html.Label("", "Title", new { @class = "app-input-descr control-label required-label font-weight-bold" })
            </div>
            <div class="col-md-12">
                <span id="spnTitle"></span>
            </div>
        </div>
        <div class="row align-items-baseline">
            <div class="col-md-12">
                @Html.Label("", "Login Id", new { @class = "app-input-descr control-label required-label font-weight-bold" })
            </div>
            <div class="col-md-12">
                <span id="spnLoginId"></span>
            </div>
        </div>
    </fieldset>

    <hr style="margin-bottom: 4em;">

    <fieldset style="margin-bottom: 2em;">
        <div class="row align-items-center">
            <div class="col-md-6">
                <legend class="app-form-heading">Contact Methods</legend>
            </div>
            <div class="col-md-6 float-right">
                <button id="btnEditContactMethods" class="btn-primary-outline float-right edit-button">Edit</button>
            </div>
        </div>
        <div class="row align-items-baseline">
            <div class="col-md-12">
                @Html.Label("", "Phone Number", new { @class = "app-input-descr control-label required-label font-weight-bold" })
            </div>
            <div class="col-md-12">
                <span id="spnPhoneNumber"></span><span id="spnExtnLabel" style="padding-left:5px;display:inline-block">Extn.</span><span id="spnExtn" style="display:inline-block">Extn:</span>
            </div>
        </div>
        <div class="row align-items-baseline">
            <div class="col-md-12">
                @Html.Label("", "Mailing Address", new { @class = "app-input-descr control-label required-label font-weight-bold" })
            </div>
            <div class="col-md-12">
                <span id="spnMailingAddress1" style="display:block"></span>
                <span id="spnMailingAddress2" style="display:block"></span>
            </div>
        </div>
    </fieldset>

    <hr style="margin-bottom: 4em;">

  @*   <fieldset style="margin-bottom: 5em;">
        <div class="row align-items-center">
            <div class="col-md-6">
                <legend class="app-form-heading">Project Registration</legend>
            </div>
            <div class="col-md-6 float-right">
                <button id="btnEditProjectRegistration" class="btn-primary-outline float-right edit-button">Edit</button>
            </div>
        </div>
        <div class="col-md-12" id="divProjectsSummary">
            
        </div>
    </fieldset> *@

    <div class="row" style="padding-bottom:5%">
        <div class="col-md-4">
            <button class="btn-primary-outline prevBtn float-left">Back</button>
        </div>
        <div class="col-md-4"></div>
        <div class="col-md-4">
            <button type="button" class="main-btn float-right" id="btnSubmit">Submit</button>
        </div>
    </div>
</div>

<script>

        function populateSummary() {
            let applicantJson = localStorage.getItem("ApplicantJson");
            if (!applicantJson) {
                console.warn("No ApplicantJson found in localStorage. Redirecting back to step 1.");
                window.location.href = "/Account/Signup"; // or wherever your first step is
                return;
            }
            // console.log("summaru page isbeingn called",applicantJson);
            if (applicantJson) {
                let data = JSON.parse(applicantJson);

                let yourInfo = data.Applicant.find(x => x.step === "YourInfo")?.Data || {};
                $("#spnName").text(
                    (yourInfo.firstName || "") + " " + (yourInfo.middleName || "") + " " + (yourInfo.lastName || "")
                );
                $("#spnCompanyName").text(yourInfo.companyName || "");
                $("#spnTitle").text(yourInfo.title || "");
                $("#spnLoginId").text(yourInfo.email || "");

                let contactInfo = data.Applicant.find(x => x.step === "ContactInfo")?.Data || {};
                $("#spnPhoneNumber").text(contactInfo.phoneNumber || "");
                $("#spnExtn").text(contactInfo.extension || "");
                $("#spnMailingAddress1").text(
                    (contactInfo.streetNumber || "") + " " +
                    (contactInfo.streetDirection || "") + " " +
                    (contactInfo.streetName || "") + " " +
                    (contactInfo.streetType || "")
                );
                $("#spnMailingAddress2").text(
                    (contactInfo.unitNumber || "") + " " +
                    (contactInfo.city || "") + " " +
                    (contactInfo.state || "") + " " +
                    (contactInfo.zipCode || "")
                );
            }
        }

     $(document).ready(function(){ 
         // populateSummary();
                //ends here
         $('#btnEditYourInfo').on('click', function () { $('a[href="#step-1"]').click() }) 
         $('#btnEditContactMethods').on('click', function () { $('a[href="#step-2"]').click(); }) 
         $('#btnEditProjectRegistration').on('click', function () { $('a[href="#step-3"]').click(); })

        $('#btnSubmit').on('click', function(){
            var applicantJson = localStorage.getItem('ApplicantJson');
            if(!applicantJson){
             console.log("inside the loal ",applicantJson);
                alert("No data found!");
                return;
            }  

            var data = JSON.parse(applicantJson);

            var accountInfo = data.Applicant.find(x => x.step === "AccountType")?.Data || {};
            var yourInfo = data.Applicant.find(x => x.step === "YourInfo")?.Data || {};
            var contactInfo = data.Applicant.find(x => x.step === "ContactInfo")?.Data || {};

            // simple validation
            if(!yourInfo.firstName || !yourInfo.lastName || !yourInfo.companyName || !yourInfo.email){
                alert("Please fill all required information in 'Your Information'");
                return;
            }

             // --- validate Contact Info ---
            if(!contactInfo.phoneNumber){
                alert("Phone number is required");
                return;
            }

             var poBoxFlag = contactInfo.poBox || "No";
            console.log("poxbox value ",poBoxFlag);
            if(poBoxFlag === "Yes"){
                // Require POBoxNumber, City, State, Zip
                if(!contactInfo.poBoxNumber || !contactInfo.city || !contactInfo.state || !contactInfo.zipCode){
                    alert("Please fill all required fields for P.O. Box address.");
                    return;
                }
            } else {
                // Require Street fields, City, State, Zip
                if(!contactInfo.streetNumber || !contactInfo.streetName || !contactInfo.streetType || !contactInfo.city || !contactInfo.state || !contactInfo.zipCode){
                    alert("Please fill all required fields for Mailing Address.");
                    return;
                }
            }
             // --- Validate Account Type ---
            if (!accountInfo.accountType) {
                alert("Account Type is missing or incomplete.");
                return;
            }
            // --- PASSWORD VALIDATION ---
            var password = $('#Password').val();
            var confirmPassword = $('#ConfirmPassword').val();

            if (!password) {
                alert("Please enter a password.");
                return;
            }

            if (password.length < 6) {
                alert("Password must be at least 6 characters long.");
                return;
            }

            if (password !== confirmPassword) {
                alert("Password and Confirm Password do not match.");
                return;
            }

         var _APPURL ='@Configuration["AppSettings:ApplicationURL"]';
             $.ajax({
              url: APPURL + "Account/XDebugCreateAccount",
                type: 'POST',
                contentType: 'application/json',
               data: applicantJson,
               success: function (data) {
                    localStorage.setItem('ApplicantJson', '');
                    $('#successModal').modal('show');
                    $('#btnOk').on('click', function () {
                       window.location.href = _APPURL ;
                    });
                },
               error: function (xhr, status, error) {
                   console.error("AJAX error:", status, error);
                   console.error("Response:", xhr.responseText);
               }
            });
        });
     });
</script>


@*ORIGINAL SCRIPT*@
@* <script>
    $(document).ready(function(){
        console.log('Summary');

        $('#btnEditYourInfo').on('click', function () { $('a[href="#step-1"]').click() })
        $('#btnEditContactMethods').on('click', function () { $('a[href="#step-2"]').click(); })
        $('#btnEditProjectRegistration').on('click', function () { $('a[href="#step-3"]').click(); })

        //Your Information data
        $('#btnSubmit').on('click', function(){

            var applicantJson = localStorage.getItem('ApplicantJson');
            var stringifiedJson = JSON.stringify(applicantJson);

            $.ajax({
                url: "/Account/CreateAccount",
                type: 'POST',
                async: false,
                dataType: 'json',
                contentType: 'application/json',
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                data: "data=" + stringifiedJson,
                success: function (data) {
                    console.log('response from controller: ' + data);
                    alert('success');
                    localStorage.setItem('ApplicantJson', '');
                    window.location.href = "/Account/Landing";
                },
                error: function (xhr) { }
            });
        });//button click
    });//ready
</script> *@
